local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local Window = Rayfield:CreateWindow({
    Name = "透视脚本",
    LoadingTitle = "透视加载中...",
    LoadingSubtitle = "透视专版",
    KeySystem = false
})

local Tab = Window:CreateTab("透视功能", 4483362458)

local ESPEnabled = false
local TracerEnabled = true
local SkeletonEnabled = true
local HighlightEnabled = true
local ESPTeamCheck = false

Tab:CreateToggle({Name="透视总开关", CurrentValue=false, Callback=function(v) ESPEnabled = v end})
Tab:CreateToggle({Name="天线绘制", CurrentValue=true, Callback=function(v) TracerEnabled = v end})
Tab:CreateToggle({Name="骨骼绘制", CurrentValue=true, Callback=function(v) SkeletonEnabled = v end})
Tab:CreateToggle({Name="内透Highlight", CurrentValue=true, Callback=function(v) HighlightEnabled = v end})
Tab:CreateToggle({Name="透视亮队友（默认关闭）", CurrentValue=false, Callback=function(v) ESPTeamCheck = v end})

local Tracers = {}
local Skeletons = {}
local Highlights = {}
local PlayersCharacterConnections = {}

local Bones = {
    {"Head", "UpperTorso"},
    {"UpperTorso", "LowerTorso"},
    {"LowerTorso", "LeftUpperLeg"}, {"LowerTorso", "RightUpperLeg"},
    {"LeftUpperLeg", "LeftLowerLeg"}, {"RightUpperLeg", "RightLowerLeg"},
    {"LeftLowerLeg", "LeftFoot"}, {"RightLowerLeg", "RightFoot"},
    {"UpperTorso", "LeftUpperArm"}, {"UpperTorso", "RightUpperArm"},
    {"LeftUpperArm", "LeftLowerArm"}, {"RightUpperArm", "RightLowerArm"},
    {"LeftLowerArm", "LeftHand"}, {"RightLowerArm", "RightHand"}
}

local DeathCheckTimer = 0
local DeathCheckInterval = 0.2
local PlayerDeathStatus = {}
local ESPRefreshTimer = 0
local ESPRefreshInterval = 0.2

local function CleanupPlayerESP(plr)
    if Tracers[plr] then 
        Tracers[plr]:Remove()
        Tracers[plr] = nil
    end
    
    if Skeletons[plr] then
        for _, bone in ipairs(Skeletons[plr]) do
            bone:Remove()
        end
        Skeletons[plr] = nil
    end
    
    if Highlights[plr] then
        Highlights[plr]:Destroy()
        Highlights[plr] = nil
    end
    
    if PlayersCharacterConnections[plr] then
        PlayersCharacterConnections[plr]:Disconnect()
        PlayersCharacterConnections[plr] = nil
    end
    
    PlayerDeathStatus[plr] = nil
end

local function CreateTracer(plr)
    if Tracers[plr] then 
        Tracers[plr]:Remove()
        Tracers[plr] = nil
    end
    
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Transparency = 1
    Tracers[plr] = line
end

local function CreateSkeleton(plr)
    if Skeletons[plr] then
        for _, bone in ipairs(Skeletons[plr]) do
            bone:Remove()
        end
        Skeletons[plr] = nil
    end
    
    local bones = {}
    for i = 1, #Bones do
        local line = Drawing.new("Line")
        line.Thickness = 2
        line.Transparency = 1
        table.insert(bones, line)
    end
    Skeletons[plr] = bones
end

local function CreateHighlight(plr)
    if Highlights[plr] then
        Highlights[plr]:Destroy()
        Highlights[plr] = nil
    end
    
    if plr and plr.Character then
        local hl = Instance.new("Highlight")
        hl.FillTransparency = 0.4
        hl.OutlineTransparency = 0
        hl.Parent = plr.Character
        Highlights[plr] = hl
    end
end

local function RefreshPlayerESP(plr)
    if not plr or not plr.Character or not plr.Character:FindFirstChild("Head") then
        return
    end
    
    if SkeletonEnabled then
        CreateSkeleton(plr)
    end
    
    if HighlightEnabled then
        CreateHighlight(plr)
    end
end

local function SetupPlayerESP(plr)
    CleanupPlayerESP(plr)
    
    CreateTracer(plr)
    if plr.Character then
        CreateSkeleton(plr)
        CreateHighlight(plr)
    end
    
    PlayersCharacterConnections[plr] = plr.CharacterAdded:Connect(function()
        task.wait(0.5)
        CreateSkeleton(plr)
        CreateHighlight(plr)
    end)
end

local function IsPlayerVisible(plr)
    if not plr.Character then return false end
    local head = plr.Character:FindFirstChild("Head")
    if not head then return false end
    
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    local ray = Workspace:Raycast(Camera.CFrame.Position, (head.Position - Camera.CFrame.Position), rayParams)
    
    return ray and ray.Instance:IsDescendantOf(plr.Character)
end

local function GetPlayerColor(plr)
    local isTeammate = plr.Team == LocalPlayer.Team
    local isVisible = IsPlayerVisible(plr)
    
    if isTeammate then
        return Color3.fromRGB(0, 255, 0)
    else
        if isVisible then
            return Color3.fromRGB(255, 0, 0)
        else
            return Color3.fromRGB(255, 255, 0)
        end
    end
end

local function UpdatePlayerDeathStatus()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == LocalPlayer then continue end
        
        local isDead = false
        local char = plr.Character
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        
        if not char or not humanoid or humanoid.Health <= 0 then
            isDead = true
        end
        
        if PlayerDeathStatus[plr] ~= isDead then
            PlayerDeathStatus[plr] = isDead
            
            if Tracers[plr] then
                Tracers[plr].Visible = not isDead
            end
            if Skeletons[plr] then
                for _, bone in ipairs(Skeletons[plr]) do
                    bone.Visible = not isDead
                end
            end
            if Highlights[plr] then
                Highlights[plr].Enabled = not isDead
            end
        end
    end
    
    for plr, _ in pairs(PlayerDeathStatus) do
        if not Players:FindFirstChild(plr.Name) then
            CleanupPlayerESP(plr)
        end
    end
end

for _, plr in pairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then
        SetupPlayerESP(plr)
    end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then
        SetupPlayerESP(plr)
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    CleanupPlayerESP(plr)
end)

RunService.Heartbeat:Connect(function(deltaTime)
    DeathCheckTimer = DeathCheckTimer + deltaTime
    ESPRefreshTimer = ESPRefreshTimer + deltaTime
    
    if DeathCheckTimer >= DeathCheckInterval then
        DeathCheckTimer = 0
        UpdatePlayerDeathStatus()
    end
    
    if ESPRefreshTimer >= ESPRefreshInterval then
        ESPRefreshTimer = 0
        if ESPEnabled then
            for _, plr in pairs(Players:GetPlayers()) do
                if plr == LocalPlayer then continue end
                if not PlayerDeathStatus[plr] and plr.Character and plr.Character:FindFirstChild("Head") then
                    if ESPTeamCheck == false and plr.Team == LocalPlayer.Team then
                    else
                        RefreshPlayerESP(plr)
                    end
                end
            end
        end
    end
    
    if not ESPEnabled then
        for _, line in pairs(Tracers) do 
            line.Visible = false 
        end
        for _, bones in pairs(Skeletons) do 
            for _, bone in ipairs(bones) do 
                bone.Visible = false 
            end 
        end
        for _, hl in pairs(Highlights) do 
            hl.Enabled = false 
        end
        return
    end

    for _, plr in pairs(Players:GetPlayers()) do
        if plr == LocalPlayer then continue end
        
        if not plr.Character or not plr.Character:FindFirstChild("Head") then
            if Tracers[plr] then Tracers[plr].Visible = false end
            if Skeletons[plr] then 
                for _, bone in ipairs(Skeletons[plr]) do
                    bone.Visible = false
                end
            end
            if Highlights[plr] then Highlights[plr].Enabled = false end
            continue
        end
        
        if PlayerDeathStatus[plr] == true then 
            if Tracers[plr] then Tracers[plr].Visible = false end
            if Skeletons[plr] then 
                for _, bone in ipairs(Skeletons[plr]) do
                    bone.Visible = false
                end
            end
            if Highlights[plr] then Highlights[plr].Enabled = false end
            continue 
        end
        
        if ESPTeamCheck == false and plr.Team == LocalPlayer.Team then
            if Tracers[plr] then Tracers[plr].Visible = false end
            if Skeletons[plr] then 
                for _, bone in ipairs(Skeletons[plr]) do
                    bone.Visible = false
                end
            end
            if Highlights[plr] then Highlights[plr].Enabled = false end
            continue
        end

        local head = plr.Character.Head
        local headPos, onScreen = Camera:WorldToViewportPoint(head.Position)
        local playerColor = GetPlayerColor(plr)

        if TracerEnabled then
            if not Tracers[plr] then CreateTracer(plr) end
            if onScreen then
                Tracers[plr].From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                Tracers[plr].To = Vector2.new(headPos.X, headPos.Y)
                Tracers[plr].Color = playerColor
                Tracers[plr].Visible = true
            else
                Tracers[plr].Visible = false
            end
        else
            if Tracers[plr] then Tracers[plr].Visible = false end
        end

        if SkeletonEnabled and onScreen then
            if not Skeletons[plr] then CreateSkeleton(plr) end
            local bones = Skeletons[plr]
            for i, bone in ipairs(Bones) do
                local p1 = plr.Character:FindFirstChild(bone[1])
                local p2 = plr.Character:FindFirstChild(bone[2])
                if p1 and p2 then
                    local pos1 = Camera:WorldToViewportPoint(p1.Position)
                    local pos2 = Camera:WorldToViewportPoint(p2.Position)
                    bones[i].From = Vector2.new(pos1.X, pos1.Y)
                    bones[i].To = Vector2.new(pos2.X, pos2.Y)
                    bones[i].Color = playerColor
                    bones[i].Visible = true
                else
                    bones[i].Visible = false
                end
            end
        elseif Skeletons[plr] then
            for _, bone in ipairs(Skeletons[plr]) do
                bone.Visible = false
            end
        end

        if HighlightEnabled then
            if not Highlights[plr] then CreateHighlight(plr) end
            if Highlights[plr] then
                Highlights[plr].FillColor = playerColor
                if plr.Team == LocalPlayer.Team then
                    Highlights[plr].OutlineColor = Color3.fromRGB(0, 200, 0)
                else
                    if IsPlayerVisible(plr) then
                        Highlights[plr].OutlineColor = Color3.fromRGB(200, 0, 0)
                    else
                        Highlights[plr].OutlineColor = Color3.fromRGB(200, 200, 0)
                    end
                end
                Highlights[plr].Enabled = true
            end
        end
    end
end)

Rayfield:Notify({Title="透视脚本 就绪", Content="透视已启动", Duration=8})
