local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local Window = Rayfield:CreateWindow({
    Name = "透视脚本",
    LoadingTitle = "透视加载中...",
    LoadingSubtitle = "透视专版",
    KeySystem = false
})

local Tab = Window:CreateTab("透视功能", 4483362458)

local ESPEnabled = false
local TracerEnabled = true
local SkeletonEnabled = true
local HighlightEnabled = true
local ESPTeamCheck = false

Tab:CreateToggle({Name="透视总开关", CurrentValue=false, Callback=function(v) ESPEnabled = v end})
Tab:CreateToggle({Name="天线绘制", CurrentValue=true, Callback=function(v) TracerEnabled = v end})
Tab:CreateToggle({Name="骨骼绘制", CurrentValue=true, Callback=function(v) SkeletonEnabled = v end})
Tab:CreateToggle({Name="内透Highlight", CurrentValue=true, Callback=function(v) HighlightEnabled = v end})
Tab:CreateToggle({Name="透视亮队友（默认关闭）", CurrentValue=false, Callback=function(v) ESPTeamCheck = v end})

local Tracers = {}
local Skeletons = {}
local Highlights = {}

local Bones = {
    {"Head", "UpperTorso"},
    {"UpperTorso", "LowerTorso"},
    {"LowerTorso", "LeftUpperLeg"}, {"LowerTorso", "RightUpperLeg"},
    {"LeftUpperLeg", "LeftLowerLeg"}, {"RightUpperLeg", "RightLowerLeg"},
    {"LeftLowerLeg", "LeftFoot"}, {"RightLowerLeg", "RightFoot"},
    {"UpperTorso", "LeftUpperArm"}, {"UpperTorso", "RightUpperArm"},
    {"LeftUpperArm", "LeftLowerArm"}, {"RightUpperArm", "RightLowerArm"},
    {"LeftLowerArm", "LeftHand"}, {"RightLowerArm", "RightHand"}
}

local DeathCheckTimer = 0
local DeathCheckInterval = 0.2
local PlayerDeathStatus = {}

local function CreateTracer(plr)
    if Tracers[plr] then return end
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Color = Color3.fromRGB(255,0,0)
    line.Transparency = 1
    Tracers[plr] = line
end

local function CreateSkeleton(plr)
    if Skeletons[plr] then return end
    local bones = {}
    for _ in Bones do
        local line = Drawing.new("Line")
        line.Thickness = 2
        line.Color = Color3.fromRGB(255,255,255)
        line.Transparency = 1
        table.insert(bones, line)
    end
    Skeletons[plr] = bones
end

local function CreateHighlight(plr)
    if not HighlightEnabled or Highlights[plr] then return end
    task.delay(math.random(3,7), function()
        if plr.Character then
            local hl = Instance.new("Highlight")
            hl.FillColor = Color3.fromRGB(0,100,255)
            hl.OutlineColor = Color3.fromRGB(255,0,0)
            hl.FillTransparency = 0.4
            hl.OutlineTransparency = 0
            hl.Parent = plr.Character
            Highlights[plr] = hl
        end
    end)
end

local function UpdatePlayerDeathStatus()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == LocalPlayer then continue end
        
        local isDead = false
        local char = plr.Character
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        
        if not char or not humanoid or humanoid.Health <= 0 then
            isDead = true
        end
        
        if PlayerDeathStatus[plr] ~= isDead then
            PlayerDeathStatus[plr] = isDead
            
            if Tracers[plr] then
                Tracers[plr].Visible = not isDead
            end
            if Skeletons[plr] then
                for _, bone in ipairs(Skeletons[plr]) do
                    bone.Visible = not isDead
                end
            end
            if Highlights[plr] then
                Highlights[plr].Enabled = not isDead
            end
        end
    end
    
    for plr, _ in pairs(PlayerDeathStatus) do
        if not Players:FindFirstChild(plr.Name) then
            PlayerDeathStatus[plr] = nil
        end
    end
end

RunService.Heartbeat:Connect(function(deltaTime)
    DeathCheckTimer = DeathCheckTimer + deltaTime
    
    if DeathCheckTimer >= DeathCheckInterval then
        DeathCheckTimer = 0
        UpdatePlayerDeathStatus()
    end
    
    if not ESPEnabled then
        for _, obj in pairs(Tracers) do obj.Visible = false end
        for _, bones in pairs(Skeletons) do for _, l in bones do l.Visible = false end end
        for _, hl in pairs(Highlights) do hl.Enabled = false end
        return
    end

    for _, plr in pairs(Players:GetPlayers()) do
        if plr == LocalPlayer or not plr.Character or not plr.Character:FindFirstChild("Head") then continue end
        
        if PlayerDeathStatus[plr] == true then continue end
        
        if ESPTeamCheck == false and plr.Team == LocalPlayer.Team then
            if Tracers[plr] then Tracers[plr].Visible = false end
            if Skeletons[plr] then for _, l in Skeletons[plr] do l.Visible = false end end
            if Highlights[plr] then Highlights[plr].Enabled = false end
            continue
        end

        local head = plr.Character.Head
        local headPos, onScreen = Camera:WorldToViewportPoint(head.Position)

        if TracerEnabled and onScreen then
            CreateTracer(plr)
            Tracers[plr].From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
            Tracers[plr].To = Vector2.new(headPos.X, headPos.Y)
            Tracers[plr].Visible = true
        end

        if SkeletonEnabled then
            CreateSkeleton(plr)
            local bones = Skeletons[plr]
            for i, bone in ipairs(Bones) do
                local p1 = plr.Character:FindFirstChild(bone[1])
                local p2 = plr.Character:FindFirstChild(bone[2])
                if p1 and p2 then
                    local pos1, vis1 = Camera:WorldToViewportPoint(p1.Position)
                    local pos2, vis2 = Camera:WorldToViewportPoint(p2.Position)
                    if vis1 and vis2 then
                        bones[i].From = Vector2.new(pos1.X, pos1.Y)
                        bones[i].To = Vector2.new(pos2.X, pos2.Y)
                        bones[i].Visible = true
                    else
                        bones[i].Visible = false
                    end
                end
            end
        end

        if HighlightEnabled then
            CreateHighlight(plr)
            if Highlights[plr] then Highlights[plr].Enabled = true end
        end
    end

    for plr, _ in pairs(Tracers) do
        if not Players:FindFirstChild(plr.Name) then
            if Tracers[plr] then Tracers[plr]:Remove() end
            Tracers[plr] = nil
            Skeletons[plr] = nil
            Highlights[plr] = nil
            PlayerDeathStatus[plr] = nil
        end
    end
end)

Rayfield:Notify({Title="透视脚本 就绪", Content="透视已启动", Duration=8})
