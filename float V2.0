local cloneref = cloneref or function(instance)
    return instance
end
local CoreGui = cloneref(game:GetService("CoreGui"))
local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local UserInputService = cloneref(game:GetService("UserInputService"))

local player = Players.LocalPlayer
local blocks = {}
local followBlock = nil
local followConnection = nil
local gui = nil
local mainFrame = nil
local isUpPressed = false
local isDownPressed = false
local currentHeight = 0
local playerConnection = nil

local isMinimized = false
local originalSize = nil
local minimizedSize = UDim2.new(0, 176, 0, 26)
local minimizeButton = nil
local closeButton = nil
local contentContainer = nil

local function IsClickInput(Input)
    return Input.UserInputType == Enum.UserInputType.MouseButton1 or 
           Input.UserInputType == Enum.UserInputType.Touch
end

local function IsHoverInput(Input)
    return Input.UserInputType == Enum.UserInputType.MouseMovement or 
           Input.UserInputType == Enum.UserInputType.Touch
end

local function MakeDraggable(UI, DragFrame)
    local StartPos
    local FramePos
    local Dragging = false
    local Changed
    
    DragFrame.InputBegan:Connect(function(Input)
        if not IsClickInput(Input) then
            return
        end

        StartPos = Input.Position
        FramePos = UI.Position
        Dragging = true

        Changed = Input.Changed:Connect(function()
            if Input.UserInputState ~= Enum.UserInputState.End then
                return
            end

            Dragging = false
            if Changed and Changed.Connected then
                Changed:Disconnect()
                Changed = nil
            end
        end)
    end)
    
    UserInputService.InputChanged:Connect(function(Input)
        if not UI.Visible or not UI.Parent or not UI.Parent.Parent then
            Dragging = false
            if Changed and Changed.Connected then
                Changed:Disconnect()
                Changed = nil
            end
            return
        end

        if Dragging and IsHoverInput(Input) then
            local Delta = Input.Position - StartPos
            UI.Position = UDim2.new(
                FramePos.X.Scale, 
                FramePos.X.Offset + Delta.X, 
                FramePos.Y.Scale, 
                FramePos.Y.Offset + Delta.Y
            )
        end
    end)
end

local function createDraggableUI()
    gui = Instance.new("ScreenGui")
    gui.Name = "floatMenu"
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = CoreGui
    
    mainFrame = Instance.new("Frame")
    mainFrame.Name = "Main"
    mainFrame.Size = UDim2.new(0, 176, 0, 132)
    mainFrame.Position = UDim2.new(0, 10, 0.0005, 0)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BackgroundTransparency = 0.8
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = true
    mainFrame.Active = true
    mainFrame.Selectable = true
    mainFrame.Parent = gui
    
    originalSize = mainFrame.Size
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 5)
    corner.Parent = mainFrame
    
    contentContainer = Instance.new("Frame")
    contentContainer.Name = "ContentContainer"
    contentContainer.Size = UDim2.new(1, 0, 1, -26)
    contentContainer.Position = UDim2.new(0, 0, 0, 26)
    contentContainer.BackgroundTransparency = 1
    contentContainer.BorderSizePixel = 0
    contentContainer.Parent = mainFrame
    
    local titleBar = Instance.new("TextLabel")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 26)
    titleBar.Position = UDim2.new(0, 0, 0, 0)
    titleBar.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    titleBar.BackgroundTransparency = 0.7
    titleBar.BorderSizePixel = 0
    titleBar.Text = "float V2.0"
    titleBar.TextColor3 = Color3.fromRGB(200, 200, 200)
    titleBar.TextSize = 15
    titleBar.Font = Enum.Font.Gotham
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 5)
    titleCorner.Parent = titleBar
    
    closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 22, 0, 22)
    closeButton.Position = UDim2.new(1, -28, 0, 2)
    closeButton.AnchorPoint = Vector2.new(1, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(120, 40, 40)
    closeButton.BackgroundTransparency = 0.7
    closeButton.BorderSizePixel = 0
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 15
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 3)
    closeCorner.Parent = closeButton
    
    minimizeButton = Instance.new("TextButton")
    minimizeButton.Name = "MinimizeButton"
    minimizeButton.Size = UDim2.new(0, 22, 0, 22)
    minimizeButton.Position = UDim2.new(1, -55, 0, 2)
    minimizeButton.AnchorPoint = Vector2.new(1, 0)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    minimizeButton.BackgroundTransparency = 0.7
    minimizeButton.BorderSizePixel = 0
    minimizeButton.Text = "-"
    minimizeButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    minimizeButton.TextSize = 18
    minimizeButton.Font = Enum.Font.GothamBold
    minimizeButton.Parent = titleBar
    
    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 3)
    minimizeCorner.Parent = minimizeButton
    
    local parallelButton = Instance.new("TextButton")
    parallelButton.Name = "Parallel"
    parallelButton.Size = UDim2.new(0.9, 0, 0, 26)
    parallelButton.Position = UDim2.new(0.05, 0, 0, 10)
    parallelButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    parallelButton.BackgroundTransparency = 0.7
    parallelButton.BorderSizePixel = 0
    parallelButton.Text = "启动float"
    parallelButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    parallelButton.TextSize = 13
    parallelButton.Font = Enum.Font.Gotham
    parallelButton.Parent = contentContainer
    
    local parallelCorner = Instance.new("UICorner")
    parallelCorner.CornerRadius = UDim.new(0, 3)
    parallelCorner.Parent = parallelButton
    
    local upButton = Instance.new("TextButton")
    upButton.Name = "Up"
    upButton.Size = UDim2.new(0.9, 0, 0, 26)
    upButton.Position = UDim2.new(0.05, 0, 0, 46)
    upButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    upButton.BackgroundTransparency = 0.7
    upButton.BorderSizePixel = 0
    upButton.Text = "向上一格"
    upButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    upButton.TextSize = 13
    upButton.Font = Enum.Font.Gotham
    upButton.Parent = contentContainer
    
    local upCorner = Instance.new("UICorner")
    upCorner.CornerRadius = UDim.new(0, 3)
    upCorner.Parent = upButton
    
    local downButton = Instance.new("TextButton")
    downButton.Name = "Down"
    downButton.Size = UDim2.new(0.9, 0, 0, 26)
    downButton.Position = UDim2.new(0.05, 0, 0, 82)
    downButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    downButton.BackgroundTransparency = 0.7
    downButton.BorderSizePixel = 0
    downButton.Text = "向下一格"
    downButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    downButton.TextSize = 13
    downButton.Font = Enum.Font.Gotham
    downButton.Parent = contentContainer
    
    local downCorner = Instance.new("UICorner")
    downCorner.CornerRadius = UDim.new(0, 3)
    downCorner.Parent = downButton
    
    MakeDraggable(mainFrame, titleBar)
    
    local function toggleMinimize()
        isMinimized = not isMinimized
        
        if isMinimized then
            mainFrame.Size = minimizedSize
            contentContainer.Visible = false
            minimizeButton.Text = "+"
        else
            mainFrame.Size = originalSize
            contentContainer.Visible = true
            minimizeButton.Text = "-"
        end
        
        if isMinimized then
            titleCorner.CornerRadius = UDim.new(0, 5)
            corner.CornerRadius = UDim.new(0, 5)
        else
            titleCorner.CornerRadius = UDim.new(0, 5)
            corner.CornerRadius = UDim.new(0, 5)
        end
    end
    
    minimizeButton.MouseButton1Click:Connect(toggleMinimize)
    
    closeButton.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
    end)
    
    local function ensurePlayerOnBlock()
        if not followBlock then return end
        
        if playerConnection then
            playerConnection:Disconnect()
        end
        
        playerConnection = RunService.Heartbeat:Connect(function()
            if not followBlock or not followBlock.Parent then
                if playerConnection then
                    playerConnection:Disconnect()
                end
                return
            end
            
            local character = player.Character
            if not character then return end
            
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            if not rootPart then return end
            
            rootPart.CFrame = CFrame.new(
                followBlock.Position.X,
                followBlock.Position.Y + 3,
                followBlock.Position.Z
            )
        end)
    end
    
    upButton.MouseButton1Down:Connect(function()
        isUpPressed = true
        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not isUpPressed or not followBlock then
                if connection then
                    connection:Disconnect()
                end
                return
            end
            currentHeight = currentHeight + 0.5
        end)
    end)
    
    upButton.MouseButton1Up:Connect(function()
        isUpPressed = false
    end)
    
    upButton.MouseLeave:Connect(function()
        isUpPressed = false
    end)
    
    downButton.MouseButton1Down:Connect(function()
        isDownPressed = true
        local connection
        connection = RunService.Heartbeat:Connect(function()
            if not isDownPressed or not followBlock then
                if connection then
                    connection:Disconnect()
                end
                return
            end
            currentHeight = currentHeight - 0.5
        end)
    end)
    
    downButton.MouseButton1Up:Connect(function()
        isDownPressed = false
    end)
    
    downButton.MouseLeave:Connect(function()
        isDownPressed = false
    end)
    
    parallelButton.MouseButton1Click:Connect(function()
        local character = player.Character
        if not character then return end
        
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if not rootPart then return end
        
        if followBlock then
            if followConnection then
                followConnection:Disconnect()
                followConnection = nil
            end
            if playerConnection then
                playerConnection:Disconnect()
                playerConnection = nil
            end
            followBlock:Destroy()
            followBlock = nil
            return
        end
        
        currentHeight = rootPart.Position.Y - 3
        
        followBlock = Instance.new("Part")
        followBlock.Name = "FollowBlock"
        followBlock.Anchored = true
        followBlock.CanCollide = true
        followBlock.Transparency = 0.7
        followBlock.BrickColor = BrickColor.new("Bright yellow")
        followBlock.Size = Vector3.new(10, 1, 10)
        followBlock.Material = Enum.Material.SmoothPlastic
        followBlock.Parent = workspace
        
        ensurePlayerOnBlock()
        
        followConnection = RunService.Heartbeat:Connect(function()
            if not character or not character.Parent then
                if followConnection then
                    followConnection:Disconnect()
                    followConnection = nil
                end
                if playerConnection then
                    playerConnection:Disconnect()
                    playerConnection = nil
                end
                if followBlock then
                    followBlock:Destroy()
                    followBlock = nil
                end
                return
            end
            
            rootPart = character:FindFirstChild("HumanoidRootPart")
            if not rootPart then return end
            
            followBlock.Position = Vector3.new(
                rootPart.Position.X,
                currentHeight,
                rootPart.Position.Z
            )
        end)
    end)
    
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.Insert then
            mainFrame.Visible = not mainFrame.Visible
        end
    end)
    
    return gui
end

createDraggableUI()