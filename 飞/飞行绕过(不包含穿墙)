local Player = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")

task.spawn(function()
    local Character = Player.Character or Player.CharacterAdded:Wait()
    local Humanoid = Character:WaitForChild("Humanoid")
    local RootPart = Character:WaitForChild("HumanoidRootPart")

    Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics, false)
    Humanoid.PlatformStand = true

    local positionBuffer = {RootPart.Position}
    RunService.Heartbeat:Connect(function()
        Humanoid:ChangeState(Enum.HumanoidStateType.Flying)
        
        table.insert(positionBuffer, 1, RootPart.Position)
        if #positionBuffer > 5 then table.remove(positionBuffer) end

        local avgPos = Vector3.new(0,0,0)
        for _, pos in ipairs(positionBuffer) do avgPos = avgPos + pos end
        avgPos = avgPos / #positionBuffer

        if (RootPart.Position - avgPos).Magnitude > 2 then
            RootPart.CFrame = CFrame.new(avgPos)
        end

        RootPart.AssemblyLinearVelocity = Vector3.new(0,0,0)
    end)

    Character:SetNetworkOwner(Player)
end)

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "✅ 飞行稳定激活",
    Text = "防拉回系统运行中",
    Duration = 3
})
