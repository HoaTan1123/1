local Player = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")

local Character = Player.Character
if not Character then
    for _ = 1, 30 do
        Character = Player.Character
        if Character then break end
        task.wait(0.1)
    end
    if not Character then Character = Player.CharacterAdded:Wait() end
end

local Humanoid, RootPart
for _ = 1, 50 do
    Humanoid = Character:FindFirstChildOfClass("Humanoid")
    RootPart = Character:FindFirstChild("HumanoidRootPart") or Character:FindFirstChild("Torso") or Character:FindFirstChild("UpperTorso")
    if Humanoid and RootPart then break end
    task.wait(0.1)
end

for _, state in pairs(Enum.HumanoidStateType:GetEnumItems()) do
    pcall(function() Humanoid:SetStateEnabled(state, false) end)
end

for _, part in pairs(Character:GetDescendants()) do
    if part:IsA("BasePart") then
        part.CanCollide = false
        part.CanTouch = false
        part.Anchored = false
        part.AssemblyLinearVelocity = Vector3.new()
        part.AssemblyAngularVelocity = Vector3.new()
    end
end

local PositionHistory = {}
local HISTORY_SIZE = 12

for _ = 1, HISTORY_SIZE do
    table.insert(PositionHistory, RootPart.Position)
end

RunService.Heartbeat:Connect(function()
    
    table.insert(PositionHistory, 1, RootPart.Position)
    if #PositionHistory > HISTORY_SIZE then
        table.remove(PositionHistory)
    end

    
    local avgPos = Vector3.new()
    for _, pos in ipairs(PositionHistory) do
        avgPos = avgPos + pos
    end
    avgPos = avgPos / #PositionHistory

    
    if (RootPart.Position - avgPos).Magnitude > 2 then
        local tweenInfo = TweenInfo.new(
            0.3,
            Enum.EasingStyle.Quad,
            Enum.EasingDirection.Out
        )
        TweenService:Create(
            RootPart,
            tweenInfo,
            {CFrame = CFrame.new(avgPos)}
        ):Play()
    end
end)

task.spawn(function()
    while true do
        
        if math.random() < 0.15 then
            Humanoid.Jump = true
        end
        task.wait(math.random(0.3, 1.2))
    end
end)

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "🛡️ 反拉回系统已激活",
    Text = "现在可以自由使用任何飞行脚本",
    Duration = 3
})
